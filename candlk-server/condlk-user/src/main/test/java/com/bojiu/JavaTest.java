package com.bojiu;

import java.io.IOException;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.util.*;

import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.bojiu.webapp.user.job.StatProfitJob;
import lombok.extern.slf4j.Slf4j;
import me.codeplayer.util.CollectionUtil;
import org.junit.jupiter.api.Test;
import org.web3j.abi.FunctionReturnDecoder;
import org.web3j.abi.TypeReference;
import org.web3j.abi.datatypes.*;
import org.web3j.abi.datatypes.generated.Uint256;
import org.web3j.protocol.Web3j;
import org.web3j.protocol.core.DefaultBlockParameterNumber;
import org.web3j.protocol.core.methods.request.EthFilter;
import org.web3j.protocol.core.methods.response.*;
import org.web3j.protocol.core.methods.response.EthBlock.TransactionObject;
import org.web3j.protocol.core.methods.response.EthBlock.TransactionResult;
import org.web3j.protocol.http.HttpService;
import org.web3j.utils.Convert;

@Slf4j
public class JavaTest {

	@Test
	public void decodeTest() {
		List outputParameters = Arrays.asList(
				new TypeReference<DynamicArray<Address>>() {
				},  // token
				new TypeReference<DynamicArray<Address>>() {
				},  // from
				new TypeReference<DynamicArray<Address>>() {
				},  // to
				new TypeReference<DynamicArray<Uint256>>() {
				}   // amount
		);
		final String inputData = "0xe19c2253000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000b00000000000000000000000000000000000000000000000000000000000000000100000000000000000000000055d398326f99059ff775485246999027b31979550000000000000000000000000000000000000000000000000000000000000028000000000000000000000000571de5b5a6734cc57c223a4f510aa652fb7fd5c5000000000000000000000000127e4c570f71aa21fcc1e4421c318ce5a377ed36000000000000000000000000428092503cb8dd8e2d011f84a4a368146c77bf69000000000000000000000000832d638beb3ffcbb0f3cbbbfdc2830831ebb5e11000000000000000000000000e21c51fe19235988253b3b9b66277605a045e86000000000000000000000000069ee696b4723d101faafc90d5b21a8b945619387000000000000000000000000dc10b1322936ce237ec48b6b2c041dce363e6aae0000000000000000000000008ad46fa7e49a1d892fe092a1619b746b8b51632f00000000000000000000000001e858bd1919617fc65c46045413b223076b344200000000000000000000000092cfecd20d299f55eeaab70e116a96c5e6bad0c70000000000000000000000003bb813f9769166d1ba2ed7f4ecd17eba13b0a3fd0000000000000000000000005997a850aaa867961c12239a4c66b0de2b88c067000000000000000000000000182193ea4784c9df827fd454b77533998b45d56100000000000000000000000072b1be8d1aedec4fc143387d218428f0d1c8df3400000000000000000000000078e6bc8c362300fc3cb13e832ce5924242d91980000000000000000000000000386f15c981c23100d43a3c67aed4fff1d20698bb000000000000000000000000c4125f8756cb7eef6f2a0d18b0d91595ebd5eaa10000000000000000000000005e6bcfd4a43a55f7762b5fa5ef7ea068fa0a294f00000000000000000000000086c2cf474ec263cd25af308340b66e22394853a200000000000000000000000003c4df68b1327f3f1c749aac8218d62f456e40120000000000000000000000004452b60373c707dce9a161a0de4e38371e6ae7c70000000000000000000000001cd86a8d1da1f861a37dec9b41dfefdfa7281469000000000000000000000000cdf6f4a6dc71f8bfeb8bbd736cd2c3b2178955e70000000000000000000000008bba6a840e274e170e59acf9078fe4b3b73e7cae00000000000000000000000069875ccd1ed979bd439e7e9065874406247d45a300000000000000000000000012835f9de01fbb163cde66cbdf146bddddf71099000000000000000000000000cb0e20403bae8ad04d27287f92f0dd2b8ce9a5070000000000000000000000001d5577fbeab7afcc6664e9d9508ebf4698a7960e0000000000000000000000001d55aeb637d761bd44cc5b514f85225cc0b8d3380000000000000000000000001ed505ae20f753f49f466fcaa8709397d07fe08a000000000000000000000000c1cb2f0acafe61210ed68dbdcb69f987bb4e87480000000000000000000000007bcc9ecbf59b9d916bc3351fccd416ae48ded08c0000000000000000000000007fb0fc6f07cc5e363bde4e3de964f21921870f62000000000000000000000000dc8e16392f2ee573ed04ce6e13426971691ef1450000000000000000000000001bedd8fde4069644e06bfd33c2d2376ff380e3530000000000000000000000008afd5bb62d5238d4d7a6b487838a04d214142cd100000000000000000000000034ec4d5e4d98ecd1f0ecc9a41a7b5da49af4ff3f000000000000000000000000c63bd91194f65f181296ed96ed8dbcbbbcba9c530000000000000000000000009d002a9eabcd0cb177ba9d2807080198b4c004590000000000000000000000001391e737fbb3176c9aa90ac3c5dfc4b330754a4e00000000000000000000000000000000000000000000000000000000000000280000000000000000000000009e10665040640d1939b3c974da90a75e04d5a5c30000000000000000000000005a0c1419592224abf2072e6430f31cebb136ece3000000000000000000000000edabeaa502ab7bcd2fb38722b8a686c767c06acd00000000000000000000000044cb8edf6411270302dab8be1003a955e2659a0b000000000000000000000000edf6aa108bd160f82aef708e276a902f405223af000000000000000000000000a1853cd9d3cf8a856976d9d0b0fc5125700dafc300000000000000000000000045cf2f56c3bf02cd95aa4af284c8b5e4a40bf1290000000000000000000000005fb944a786b0d7f74ca4f4dcc85511caa01be714000000000000000000000000fe5e711f4cd525a58a681312c2f2c067002e808a000000000000000000000000b6c35d588b59e0fbfbd37d85bef7f26eb38c3d330000000000000000000000004ac5ae363428a8824d240f0c065a048aa12fd537000000000000000000000000da48805b22773c200652dc7b65408851f450210d0000000000000000000000009fb01dcdd86bfd512c4779d599782fc4d149933a000000000000000000000000241e6e153cfe1749483f0bd86a647ff6e250f2a1000000000000000000000000ee45afcc62cccfc1e630f10b3ab193d6ba2eb66a00000000000000000000000062dc3b78df9a8f8f85bdad28d3d028f3b75c2df90000000000000000000000001350ece9cd9de08809ca545308b4e2d30003f58000000000000000000000000085435078bcd88ba0ce92d5976724abadc38591590000000000000000000000004b9d7f249456972f1027875f7138d8e67542aee7000000000000000000000000e68320dd126efb6c6505d145d1886855362d1c91000000000000000000000000f7912796639ceffedcc49993abe9251f2be0fc200000000000000000000000001c6a6ea5a93b44a769c9069195bc15ff6baf26d800000000000000000000000013413fabcb87ef9212f5a3f101fa00a9200cb05d0000000000000000000000009280bb46126c4c53a49cc5fb86f8acdb23401fb6000000000000000000000000e890cc0c59a6a12ba6fb1a4d281e7165925decf2000000000000000000000000c6eb73100f4df71658e572da94022bf46ef0b57a00000000000000000000000058f8bdf4cbf208c975b89f8ebab8821bfc519d3000000000000000000000000089c6c7d3c1ec719dc7809d4158d0faf0d5b034a400000000000000000000000078f344800541d9c89ad32b2653c8f44259477649000000000000000000000000777a3323276c93caf1f056c6a3bbf3df5a06e15a000000000000000000000000db4f0b053a808dc5c18cb83866d561bed0fe8ecc00000000000000000000000028ec222d85cd6a906c7e24366707568101705f660000000000000000000000004a751f17fb05b6e4df9588bd366d64774281108d0000000000000000000000005ac2a1beaa46f4d21338e11077e936251006f3cc000000000000000000000000c46dac191823763c71de2f1ab32920e470e7f41900000000000000000000000038c0fe9f23ab4d2984759f06a1236d840ad18023000000000000000000000000d6f7c59d72dc3fd5db9f30447a11eb9a60960bfc000000000000000000000000232420e494809302a58d4fab19660cb5c684aa86000000000000000000000000dd05fae43d2aeb141b46e1042b4bbdc3a25c645a0000000000000000000000004491aa46f7c64b2a1d100c719228716cd2012d960000000000000000000000000000000000000000000000000000000000000029000000000000000000000000000000000000000000000003782dace9d900000000000000000000000000000000000000000000000000043c33c1937564800000000000000000000000000000000000000000000000000026a1335886992800000000000000000000000000000000000000000000000000151ae2322b7ddd5be800000000000000000000000000000000000000000000002879280857faa400000000000000000000000000000000000000000000000000016f63d6000eb955ca000000000000000000000000000000000000000000000038dfd9893833ef3b02000000000000000000000000000000000000000000000002a48acab6204b000000000000000000000000000000000000000000000000000ee86442fcd06c0000000000000000000000000000000000000000000000000001f46edaf228960000000000000000000000000000000000000000000000000003cb71f51fc55800000000000000000000000000000000000000000000000000055fb481c968790000000000000000000000000000000000000000000000000005f68e8131ecf8000000000000000000000000000000000000000000000000005fec510c1ffcfe40000000000000000000000000000000000000000000000000375938aa8299d400000000000000000000000000000000000000000000000000122bb21916572f000000000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000003860e639d8064000000000000000000000000000000000000000000000000002b5e3af16b188000000000000000000000000000000000000000000000000000241a9b4f617a280000000000000000000000000000000000000000000000000006124fee993bc00000000000000000000000000000000000000000000000000051192ba9da3060000000000000000000000000000000000000000000000000000a6ff7fc954ba1fb6b00000000000000000000000000000000000000000000000c16bf267ed01c0000000000000000000000000000000000000000000000000015af1d78b58c40000000000000000000000000000000000000000000000000009c734bad511158000000000000000000000000000000000000000000000000001b1ae4d6e2ef500000000000000000000000000000000000000000000000000000a688906bd8b00000000000000000000000000000000000000000000000000003860e639d80640000000000000000000000000000000000000000000000000002d3555cf92d0aa69c00000000000000000000000000000000000000000000002d51d4a2aea29000000000000000000000000000000000000000000000000000258e88096366a0000000000000000000000000000000000000000000000000006c6b935b8bbd4000000000000000000000000000000000000000000000000001d653afe094f91000000000000000000000000000000000000000000000000000056beae51fd2d100000000000000000000000000000000000000000000000000008ac7230489e80000000000000000000000000000000000000000000000000009943481cda386000000000000000000000000000000000000000000000000001eb236cde9244a00000000000000000000000000000000000000000000000000056bc75e2d6310000000000000000000000000000000000000000000000000002d7271833b38bb0000000000000000000000000000000000034b6e255f6e5e5c25070ca2c56e8071c7"
				.substring(10);

		// 3. 使用 Web3j 解码器解析
		List<Type> results = FunctionReturnDecoder.decode(inputData, outputParameters);
		List<Address> tokens = (List<Address>) results.get(0).getValue();
		List<Address> froms = (List<Address>) results.get(1).getValue();
		List<Address> tos = (List<Address>) results.get(2).getValue();
		List<Uint256> amounts = (List<Uint256>) results.get(3).getValue();
		System.out.println("Token: " + tokens + ", From: " + froms + ", To: " + tos + ", Amount: " + amounts);
	}

	@Test
	public void loadContractTest() {
		final HttpService service = new HttpService("https://bsc-mainnet.public.blastapi.io/");
		service.addHeader("referer", "https://four.meme/");
		service.addHeader("origin", "https://four.meme");
		// 目标合约地址 (A合约)
		final String contractAddress = "0x231bdd87ade0feb934a981f9a4442cc2bac110c8";
		// 目标方法的 Method ID
		final String targetMethodId = "0xe19c2253";

		// 定义函数参数结构（对应 address[], address[], address[], uint256[]）
		final List outputParameters = Arrays.asList(
				new TypeReference<DynamicArray<Address>>() {
				},  // token
				new TypeReference<DynamicArray<Address>>() {
				},  // from
				new TypeReference<DynamicArray<Address>>() {
				},  // to
				new TypeReference<DynamicArray<Uint256>>() {
				}   // amount
		);
		final Map<String, String> tokenMap = CollectionUtil.asLinkedHashMap(
				"USDT", "0x55d398326f99059fF775485246999027B3197955",
				"USDC", "0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d",
				"BUSD", "0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56",
				"FDUSD", "0xc5f0f7b66764F6ec8C8Dff7BA683102295E16409",
				"ETH", "0x2170ed0880ac9a755fd29b2688956bd959f933f8"
		);
		final String[] tokenName = tokenMap.keySet().toArray(new String[0]);
		try (Web3j web3j = Web3j.build(service)) {
			BigInteger lastBlock = web3j.ethBlockNumber().send().getBlockNumber();

			while (true) {
				final EthBlock.Block block = web3j.ethGetBlockByNumber(new DefaultBlockParameterNumber(lastBlock), true).send().getBlock();
				log.info("正在执行扫描区块：{}", lastBlock);
				if (block == null) {
					Thread.sleep(500);
					continue;
				}
				lastBlock = lastBlock.add(BigInteger.ONE);
				final List<TransactionResult> txs = block.getTransactions();
				if (CollectionUtils.isEmpty(txs)) {
					continue;
				}
				for (TransactionResult txR : txs) {
					final TransactionObject tx = (TransactionObject) txR.get();

					// 过滤：目标合约且 MethodID 匹配
					if (contractAddress.equalsIgnoreCase(tx.getTo()) && tx.getInput() != null && tx.getInput().startsWith(targetMethodId)) {
						// 截取 Data（去掉前 10 位的 0x 和 MethodID）
						final String inputData = tx.getInput().substring(10);
						// 使用 Web3j 解码器解析
						final List<Type> results = FunctionReturnDecoder.decode(inputData, outputParameters);
						if (results.isEmpty()) {
							continue;
						}
						log.info("--------------------------------------------------");
						log.info("发现目标调用! Hash: {}", tx.getHash());

						final List<Address> froms = (List<Address>) results.get(1).getValue(), tos = (List<Address>) results.get(2).getValue();
						final List<Uint256> amounts = (List<Uint256>) results.get(3).getValue();
						// Token类型标记，一共40位，-1后等于tokenName数组下标，与froms倒序对应，使用size-i的方式解析
						final String bizFlag = amounts.getLast().getValue().toString();

						// 打印解析出的具体数据
						for (int i = 0, size = froms.size(); i < size; i++) {
							final int offset = Integer.parseUnsignedInt(bizFlag, size - i - 1, size - i, 10) - 1;
							if (offset < tokenName.length) {
								log.info("序号 [{}]: Token: {}, From: {}, To: {}, Amount: {}", i, tokenName[offset],
										froms.get(i).getValue(), tos.get(i).getValue(), amounts.get(i).getValue());
							} else {
								log.warn("【无法解析】序号 [{}]: Token: {}, From: {}, To: {}, Amount: {}", i, offset,
										froms.get(i).getValue(), tos.get(i).getValue(), amounts.get(i).getValue());
							}
						}
					}
				}
			}
		} catch (Exception e) {
			log.error("Error: ", e);
		}
	}

	@Test
	public void filterLogTest() throws IOException {
		final HttpService service = new HttpService("https://rpc.sentio.xyz/bsc");
		// service.addHeader("referer", "https://swap.transit.finance/");
		// service.addHeader("origin", "https://swap.transit.finance");
		// service.addHeader("user-agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/144.0.0.0 Safari/537.36");
		BigInteger fromBlock = BigInteger.valueOf(79559448);
		BigInteger toBlock = BigInteger.valueOf(79559449);
		final List<String> values = new ArrayList<>(StatProfitJob.tokenMap.values());
		EthFilter filter = new EthFilter(
				new DefaultBlockParameterNumber(fromBlock),
				new DefaultBlockParameterNumber(toBlock),
				values
		);
		filter.addSingleTopic("0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef");
		Web3j web3j = Web3j.build(service);
		// 2. 获取日志
		EthLog ethLog = web3j.ethGetLogs(filter).send();
		if (ethLog.hasError()) {
			log.error("Error: {}", ethLog.getError().getMessage());
			return;
		}
		List<EthLog.LogResult> logs = ethLog.getLogs();
		for (EthLog.LogResult logResult : logs) {
			final Log l = (Log) logResult.get();
			// 解析 Topic2 (indexed to)
			final List<String> topics = l.getTopics();
			final int size = topics.size();
			if (size == 3) {
				BigDecimal rawAmount = new BigDecimal(new BigInteger(l.getData().substring(2), 16));
				BigDecimal amount = Convert.fromWei(rawAmount, Convert.Unit.ETHER);
				final String toAddress = "0x" + topics.get(2).substring(26);
				log.info("转账：To: {} ,amount: {} ,block: {}, Hash: {}", toAddress, amount, l.getBlockNumber(), l.getTransactionHash());
			} else {
				log.info("跳过：Size: {}, Topics: {}, Hash: {}", size, topics, l.getTransactionHash());
			}
		}
	}

}